server {
  listen 80;
  # ① Evita que Nginx “complete” la URL con un redirect absoluto
  absolute_redirect off;

  sendfile        on;
  default_type    application/octet-stream;
  gzip on;
  # … tu configuración de gzip …

  root /usr/share/nginx/html;

  # ————————————————————————————————————————————
  # ② CUBRE /api/compras Y /api/compras/ SIN REDIRECT
  location ^~ /api/compras {
    proxy_pass         http://microservicio-de-compras-facturacion:8082;
    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_redirect  ~^https?://[^/]+(:\d+)?(/api/.*)$   $2;

    # CORS + preflight
    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin      $http_origin always;
      add_header Access-Control-Allow-Methods     'GET, POST, PUT, DELETE, OPTIONS' always;
      add_header Access-Control-Allow-Headers     'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Max-Age           1728000 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin      $http_origin always;
    add_header Access-Control-Allow-Methods     'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers     'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Max-Age           1728000 always;
  }

  # ————————————————————————————————————————————
  # ③ CUBRE /api/facturas Y /api/facturas/ SIN REDIRECT
  location ^~ /api/facturas {
    proxy_pass         http://microservicio-de-compras-facturacion:8082;
    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_redirect  ~^https?://[^/]+(:\d+)?(/api/.*)$   $2;

    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin      $http_origin always;
      add_header Access-Control-Allow-Methods     'GET, POST, PUT, DELETE, OPTIONS' always;
      add_header Access-Control-Allow-Headers     'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Max-Age           1728000 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin      $http_origin always;
    add_header Access-Control-Allow-Methods     'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers     'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Max-Age           1728000 always;
  }

  # ————————————————————————————————————————————
  # ④ CUBRE TODAS LAS DEMÁS RUTAS /api (incluye guías‑despacho si está en gps-backend)
  location ^~ /api {
    proxy_pass         http://gps-backend:8080/api;
    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin      $http_origin always;
      add_header Access-Control-Allow-Methods     'GET, POST, PUT, DELETE, OPTIONS' always;
      add_header Access-Control-Allow-Headers     'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
      add_header Access-Control-Allow-Credentials true always;
      add_header Access-Control-Max-Age           1728000 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin      $http_origin always;
    add_header Access-Control-Allow-Methods     'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers     'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Max-Age           1728000 always;
  }

  # ————————————————————————————————————————————
  # ⑤ Tu SPA Angular
  location / {
    try_files $uri $uri/ /index.html;
  }
}
